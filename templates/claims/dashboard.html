{% extends 'base.html' %}

{% block title %}Dashboard - Claims Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 fs-3 fs-md-2">Dashboard</h1>
</div>

<!-- Summary Statistics -->
<div class="row g-3 mb-4" x-data="{ showDetails: false }">
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card stats-card h-100 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1 fs-6">
                            Total Claims
                        </div>
                        <div class="h5 mb-0 fw-bold text-white fs-4 fs-md-3">{{ total_claims|floatformat:0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clipboard-list fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card stats-card h-100 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1 fs-6">
                            Total Amount
                        </div>
                        <div class="h5 mb-0 fw-bold text-white fs-4 fs-md-3">${{ total_billed|floatformat:2 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card stats-card h-100 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1 fs-6">
                            Average Claim
                        </div>
                        <div class="h5 mb-0 fw-bold text-white fs-4 fs-md-3">
                            ${{ average_claim|floatformat:2|default:"0.00" }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card stats-card h-100 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1 fs-6">
                            Flagged Claims
                        </div>
                        <div class="h5 mb-0 fw-bold text-white fs-4 fs-md-3">
                            {{ total_flagged }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-flag fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="m-0 fw-bold fs-6">Claims by Status</h6>
            </div>
            <div class="card-body p-3 p-md-4">
                <div class="position-relative" style="height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="m-0 fw-bold fs-6">Claims by Policy</h6>
            </div>
            <div class="card-body p-3 p-md-4">
                <div class="position-relative" style="height: 300px;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Claims -->
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h6 class="m-0 fw-bold fs-6">Recent Claims</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-nowrap">Claim ID</th>
                        <th class="text-nowrap">Claimant</th>
                        <th class="text-nowrap">Status</th>
                        <th class="text-nowrap">Date</th>
                        <th class="text-nowrap">Policy</th>
                        <th class="text-nowrap">Amount</th>
                        <th class="text-nowrap">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for claim in recent_claims %}
                    <tr>
                        <td class="text-nowrap">{{ claim.id }}</td>
                        <td class="text-break">{{ claim.patient_name }}</td>
                        <td class="text-nowrap">
                            <span class="badge bg-{% if claim.status == 'Paid' %}success{% elif claim.status == 'Under Review' %}warning{% elif claim.status == 'Denied' %}danger{% else %}info{% endif %} fs-6">
                                {{ claim.status }}
                            </span>
                        </td>
                        <td class="text-nowrap">{{ claim.discharge_date|date:"M d, Y" }}</td>
                        <td class="text-break">{{ claim.insurer_name }}</td>
                        <td class="text-nowrap">${{ claim.billed_amount|floatformat:2 }}</td>
                        <td class="text-nowrap">
                            <a href="{% url 'claims:claim_detail' claim.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>
                                <span class="d-none d-sm-inline">View</span>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No recent claims found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
         labels: [{% for status in claims_by_status %}'{{ status.status }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for status in claims_by_status %}{{ status.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#007AFF',
                '#34C759',
                '#5AC8FA',
                '#FF9500',
                '#FF3B30'
            ],
            hoverBackgroundColor: [
                '#0056CC',
                '#2EAD4E',
                '#4AB8E6',
                '#E6850E',
                '#E62E26'
            ],
            hoverBorderColor: "rgba(255, 255, 255, 1)",
            borderWidth: 2,
            borderColor: '#fff'
        }],
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    },
});

// Type Chart
const typeCtx = document.getElementById('typeChart').getContext('2d');
const typeChart = new Chart(typeCtx, {
    type: 'bar',
    data: {
         labels: [{% for insurer in claims_by_insurer %}'{{ insurer.insurer_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Claims',
            data: [{% for insurer in claims_by_insurer %}{{ insurer.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#007AFF',
                '#34C759',
                '#5AC8FA',
                '#FF9500',
                '#FF3B30',
                '#5856D6',
                '#FF2D92',
                '#AF52DE',
                '#FF9500',
                '#FF6B35'
            ],
            borderColor: [
                '#0056CC',
                '#2EAD4E',
                '#4AB8E6',
                '#E6850E',
                '#E62E26',
                '#4A4AC8',
                '#E61E7A',
                '#9B4AC8',
                '#E6850E',
                '#E65A2E'
            ],
            borderWidth: 2
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}
